# 代码阅读指南

面向首次阅读代码的同学，下面梳理了核心目标、数据流、关键模块和推荐的阅读顺序，方便在 IDE 里快速定位。

## 项目概览与运行方式
- 目标：提供基于 JSON Schema 的实体存储/查询服务，底层落地到 PostgreSQL 的 “热字段表 + EAV 表” 双存储结构，支持排序、条件组合和跨 Schema 查询。
- 入口：`cmd/server/main.go` 读取环境变量拼装 `internal.Config`，通过 `cmd/server/factory.go` 构建 `EntityManager`、元数据缓存和 HTTP 路由（`cmd/server/handlers.go`）。
- 配置：默认配置在 `internal/config.go`，数据库表名可通过 `Config.Database.TableNames` 覆盖，运行时通过 `DB_HOST/DB_PORT/DB_NAME/DB_USER/DB_PASSWORD/DB_SSL_MODE` 等环境变量注入。
- 运行与构建：开发期可直接 `go run ./cmd/server`；统一测试命令为 `go test ./...`（参见根目录 `Makefile`）；`make build` 会为常见平台产出二进制到 `build/`。
- 依赖数据：Schema 定义与属性映射位于 `cmd/server/schemas/*.json` 与 `*_attributes.json`，示例有 `lead` 与 `listing`。

## 数据流速览
1) **HTTP → Handler**：`cmd/server/handlers.go` 解析路径/查询参数/请求体，转成 `forma.EntityOperation` 或 `forma.QueryRequest` 调用 manager。  
2) **业务层 (EntityManager)**：`internal/entity_manager.go` 负责校验、Schema 解析、组装排序/分页、调用存储层，并将持久化记录还原为 `forma.DataRecord`。  
3) **转换层**：`internal/transformer.go` 把 JSON 展平为属性列表（含数组索引）、或反向重建嵌套结构；`internal/persistent_transformer.go` 决定哪些属性落在主表热列、哪些保留在 EAV。  
4) **存储层**：`internal/postgres_persistent_repository.go` 使用 pgx 访问两张表；插入/更新走事务，查询时先在 EAV 表里筛选/排序（`advanced_query_template.go` 与 `sql_generator.go` 生成 SQL），再回表补全主表字段。  
5) **元数据**：`internal/metadata_loader.go` 从数据库表（默认 `schema_registry`）加载 SchemaID 与属性映射，再结合磁盘上的 `*_attributes.json` 形成 `MetadataCache`，供查询/转换层快速查表。额外的文件式 `SchemaRegistry` 在 `internal/schema_registry.go`，兼容老路径。  
6) **扩展/实验**：`internal/queryoptimizer` 目录放着尚未实现的优化器骨架（当前返回 `ErrNotImplemented`），阅读时可忽略其调用路径。

## 关键模块卡片
- **接口与模型**：`types.go` 描述 API 层结构体，`internal/interfaces.go` 定义核心接口（Transformer、PersistentRecordRepository 等）和内部持久化模型 `PersistentRecord`。
- **Transformer**：`internal/transformer.go` 负责 JSON ↔ 属性的双向转换，支持数组索引压缩为 `ArrayIndices` 字符串，并按属性定义类型做解析/校验。
- **持久化 Transformer**：`internal/persistent_transformer.go` 依据属性的 `MainColumnBinding` 将值写入 `PersistentRecord` 的各列 map（文本、小整型、整型、大整型、双精度）或 EAV 列表，并提供反向读取。
- **元数据解析**：`internal/metadata_types.go`/`internal/metadata_parser.go` 描述属性元数据字段（ValueType、主表绑定、回退存储等），解析 `*_attributes.json` 时会自动推导存储/回退信息。
- **存储与 SQL**：`internal/postgres_persistent_repository.go` 实现 CRUD 与高级查询。过滤条件由 `internal/sql_generator.go` 把 `CompositeCondition/KvCondition` 递归翻译成子查询 EXISTS 片段；排序依赖 `advanced_query_template.go` 生成的 CTE，对排序键做一次性查询并带回总数。
- **业务编排**：`internal/entity_manager.go` 组合以上组件，实现 Create/Update/Delete/Query/Batch/CrossSchemaSearch，并在 `storageTables()` 里读取配置定义的表名。
- **HTTP 层**：`cmd/server/handlers.go` 支持的路由包括：
  - `POST /api/v1/{schema}` 创建（支持单条或数组）
  - `GET /api/v1/{schema}` 分页查询；`GET /api/v1/{schema}/{row_id}` 读取单条
  - `PUT /api/v1/{schema}/{row_id}` 更新（整对象覆盖式）
  - `DELETE /api/v1/{schema}` 批量删除；`DELETE /api/v1/{schema}/{row_id}` 单条删除
  - `POST /api/v1/advanced_query` 组合条件查询；`GET /api/v1/search` 跨 schema 搜索占位实现
  辅助解析/响应函数在 `cmd/server/utils.go`。
- **测试**：单元测试覆盖转换/SQL 生成等（如 `internal/transformer_test.go`、`internal/sql_generator_test.go`）；`internal/integration_suite_test.go` 和 `internal/postgres_persistent_repository_integration_test.go` 需要可访问的 Postgres（默认 `TEST_POSTGRES_DSN` / `DATABASE_URL`，否则自动 skip）。

## 推荐阅读路径
1. `types.go` 了解外部 API/模型；`internal/interfaces.go` 看内部接口与持久化模型。
2. `cmd/server/main.go` + `cmd/server/factory.go` 理解启动流程、配置来源与依赖注入。
3. `internal/config.go` 熟悉可调参数和表名配置；同时浏览 `cmd/server/schemas` 感受 Schema/属性声明格式。
4. `internal/metadata_loader.go` 与 `internal/schema_registry.go` 理解元数据的来源（DB vs. 文件）及缓存结构。
5. `internal/transformer.go` → `internal/persistent_transformer.go` → `internal/metadata_types.go` 形成对数据展平与热列绑定的整体认识。
6. `internal/postgres_persistent_repository.go`（配合 `advanced_query_template.go`、`sql_generator.go`）阅读持久化与查询执行逻辑。
7. 回到 `internal/entity_manager.go` 理解业务编排与错误处理，再看 `cmd/server/handlers.go` 了解 HTTP 映射。
8. 最后根据需要浏览 `internal/queryoptimizer`（实验性）、`docs/*.md`（功能说明），和对应测试用例验证行为。

## 现有文档速查
- `docs/api.md`：API 形态与示例。
- `docs/query.md` / `docs/advanced_query.md`：查询能力介绍。
- `docs/OPTIMIZER_IMPLEMENTATION.md`、`docs/query_optimizer.md`：优化器设计思路草稿。
- `docs/schema_versioning.md`、`docs/model.md`、`docs/Roadmap.md`：版本、数据模型及规划。
